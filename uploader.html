<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CineAutoClip - 视频上传</title>
    <!-- 使用 Tailwind CSS 美化界面 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 自定义字体和过渡效果 */
        body {
            font-family: 'Inter', sans-serif;
        }
        .progress-bar-inner {
            transition: width 0.3s ease-in-out;
        }
    </style>
</head>
<body class="bg-gray-900 text-white flex items-center justify-center min-h-screen p-4">
    <div class="bg-gray-800 p-8 rounded-2xl shadow-2xl w-full max-w-lg border border-gray-700">
        <h1 class="text-3xl font-bold mb-2 text-center text-indigo-400">CineAutoClip</h1>
        <p class="text-gray-400 mb-6 text-center">电影自动化剪辑工作流 - 上传入口</p>

        <div class="mb-4">
            <label for="n8n-webhook-url" class="block text-sm font-medium text-gray-300 mb-1">n8n 授权 Webhook URL</label>
            <input type="text" id="n8n-webhook-url" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white focus:ring-2 focus:ring-indigo-500 focus:outline-none" placeholder="请粘贴 n8n 生成上传许可的 Webhook URL">
        </div>

        <div class="mb-6">
            <label for="video-file" class="block text-sm font-medium text-gray-300 mb-1">选择电影文件</label>
            <input type="file" id="video-file" class="w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-indigo-600 file:text-white hover:file:bg-indigo-700 cursor-pointer">
        </div>

        <button id="upload-button" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300 disabled:bg-gray-500 disabled:cursor-not-allowed">
            开始上传
        </button>

        <div id="status-container" class="mt-6 text-center hidden">
            <p id="status-text" class="text-gray-300"></p>
            <div id="progress-bar" class="w-full bg-gray-700 rounded-full mt-2 h-4 hidden">
                <div id="progress-bar-inner" class="bg-green-500 h-4 rounded-full" style="width: 0%"></div>
            </div>
             <p id="progress-text" class="text-sm text-gray-400 mt-1"></p>
        </div>
    </div>

    <script>
        const n8nWebhookUrlInput = document.getElementById('n8n-webhook-url');
        const videoFileInput = document.getElementById('video-file');
        const uploadButton = document.getElementById('upload-button');
        const statusContainer = document.getElementById('status-container');
        const statusText = document.getElementById('status-text');
        const progressBar = document.getElementById('progress-bar');
        const progressBarInner = document.getElementById('progress-bar-inner');
        const progressText = document.getElementById('progress-text');

        // 在页面加载时，尝试从 localStorage 读取已保存的 Webhook URL
        n8nWebhookUrlInput.value = localStorage.getItem('n8nWebhookUrl') || '';

        uploadButton.addEventListener('click', async () => {
            const webhookUrl = n8nWebhookUrlInput.value.trim();
            const file = videoFileInput.files[0];

            if (!webhookUrl || !file) {
                alert('请填写 Webhook URL 并选择文件！');
                return;
            }

            // 保存 Webhook URL 到 localStorage，方便下次使用
            localStorage.setItem('n8nWebhookUrl', webhookUrl);

            uploadButton.disabled = true;
            statusContainer.classList.remove('hidden');
            progressBar.classList.add('hidden');
            progressBarInner.style.width = '0%';
            statusText.textContent = '初始化...';

            try {
                // --- 步骤 1.1: 请求上传许可 ---
                statusText.textContent = '1/3: 正在向 n8n 请求上传许可...';
                const response = await fetch(`${webhookUrl}?fileName=${encodeURIComponent(file.name)}`);

                if (!response.ok) {
                    throw new Error(`获取上传许可失败: ${response.statusText}`);
                }
                
                const data = await response.json();
                const presignedUploadUrl = data.url;

                if (!presignedUploadUrl) {
                    throw new Error('n8n 未返回有效的预签名 URL。');
                }
                
                statusText.textContent = '2/3: 许可获取成功，正在上传文件至阿里云 OSS...';
                progressBar.classList.remove('hidden');
                
                // --- 步骤 1.3: 直传文件至阿里云 OSS ---
                await uploadFile(presignedUploadUrl, file);

                statusText.textContent = '3/3: 上传成功！后端工作流已自动触发。';
                progressBarInner.style.width = '100%';
                progressText.textContent = '100%';

            } catch (error) {
                statusText.textContent = `上传失败: ${error.message}`;
                progressBar.classList.add('hidden');
            } finally {
                uploadButton.disabled = false;
            }
        });

        // 使用 XMLHttpRequest 来获取上传进度
        function uploadFile(url, file) {
            return new Promise((resolve, reject) => {
                const xhr = new XMLHttpRequest();
                xhr.open('PUT', url, true);
                
                xhr.upload.onprogress = (event) => {
                    if (event.lengthComputable) {
                        const percentComplete = (event.loaded / event.total) * 100;
                        progressBarInner.style.width = percentComplete + '%';
                        progressText.textContent = `${Math.round(percentComplete)}% (${(event.loaded / 1024 / 1024).toFixed(2)}MB / ${(event.total / 1024 / 1024).toFixed(2)}MB)`;
                    }
                };

                xhr.onload = () => {
                    if (xhr.status >= 200 && xhr.status < 300) {
                        resolve(xhr.response);
                    } else {
                        reject(new Error(`上传至 OSS 失败，状态码: ${xhr.status}`));
                    }
                };

                xhr.onerror = () => {
                    reject(new Error('网络错误导致上传失败。'));
                };

                xhr.setRequestHeader('Content-Type', file.type || 'application/octet-stream');
                xhr.send(file);
            });
        }
    </script>
</body>
</html>

