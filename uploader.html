<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CineAutoClip - 视频上传</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap"
    rel="stylesheet"
  />
  <style>
    body {
      font-family: "Inter", sans-serif;
    }
    .progress-bar-inner {
      transition: width 0.4s ease-in-out;
    }
    .spinner {
      border-color: transparent;
      border-top-color: #6366f1; /* indigo-500 */
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }
  </style>
</head>
<body
  class="bg-gray-900 text-white flex items-center justify-center min-h-screen p-4"
>
  <div
    class="bg-gray-800 p-8 rounded-2xl shadow-2xl w-full max-w-lg border border-gray-700"
  >
    <!-- header -->
    <div class="flex items-center justify-center mb-4">
      <svg
        class="w-10 h-10 text-indigo-400"
        xmlns="http://www.w3.org/2000/svg"
        fill="none"
        viewBox="0 0 24 24"
        stroke-width="1.5"
        stroke="currentColor"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          d="M15.59 14.37a6 6 0 01-5.84 7.38v-4.82m5.84-2.56a12.022 12.022 0 01A12.022 12.022 0 013.882 14.37m5.84 7.38a12.022 12.022 0 01-2.062-6.572M12 6a2.25 2.25 0 012.25 2.25V12a2.25 2.25 0 01-4.5 0V8.25A2.25 2.25 0 0112 6z"
        />
      </svg>
      <h1 class="text-3xl font-bold ml-3 text-indigo-400">CineAutoClip</h1>
    </div>
    <p class="text-gray-400 mb-8 text-center">
      电影自动化剪辑工作流 - 上传入口
    </p>

    <!-- file upload -->
    <div class="mb-6">
      <label
        for="video-file"
        id="drop-zone"
        class="w-full cursor-pointer bg-gray-700 border-2 border-dashed border-gray-600 rounded-lg flex flex-col items-center justify-center p-6 hover:bg-gray-600 transition duration-300"
      >
        <svg
          class="w-10 h-10 text-gray-400 mb-3"
          xmlns="http://www.w3.org/2000/svg"
          fill="none"
          viewBox="0 0 24 24"
          stroke-width="1.5"
          stroke="currentColor"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5m-13.5-9L12 3m0 0l4.5 4.5M12 3v13.5"
          />
        </svg>
        <span id="file-label-text" class="text-gray-300"
          >选择或拖拽电影文件</span
        >
        <span id="file-name-display" class="text-sm text-indigo-400 mt-1"></span>
      </label>
      <input type="file" id="video-file" class="hidden" />
    </div>

    <!-- upload button -->
    <button
      id="upload-button"
      class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300 disabled:bg-gray-500 disabled:cursor-not-allowed flex items-center justify-center"
    >
      <span id="button-text">开始上传</span>
      <div
        id="button-spinner"
        class="spinner w-5 h-5 rounded-full border-2 ml-3 hidden"
      ></div>
    </button>

    <!-- status -->
    <div
      id="status-container"
      class="mt-6 text-center hidden transition-all duration-300"
    >
      <div class="flex items-center justify-center">
        <div id="status-icon" class="mr-2"></div>
        <p id="status-text" class="text-gray-300"></p>
      </div>
      <div
        id="progress-bar"
        class="w-full bg-gray-700 rounded-full mt-2 h-3 hidden"
      >
        <div
          id="progress-bar-inner"
          class="bg-green-500 h-3 rounded-full progress-bar-inner"
          style="width: 0%"
        ></div>
      </div>
      <p id="progress-text" class="text-xs text-gray-400 mt-1"></p>
    </div>
  </div>

  <script>
    const N8N_AUTHORIZATION_URL =
      "https://n8n.hyl.me.uk/webhook/generate-oss-upload-url";

    const videoFileInput = document.getElementById("video-file");
    const uploadButton = document.getElementById("upload-button");
    const statusContainer = document.getElementById("status-container");
    const statusText = document.getElementById("status-text");
    const progressBar = document.getElementById("progress-bar");
    const progressBarInner = document.getElementById("progress-bar-inner");
    const progressText = document.getElementById("progress-text");
    const fileLabelText = document.getElementById("file-label-text");
    const fileNameDisplay = document.getElementById("file-name-display");
    const buttonText = document.getElementById("button-text");
    const buttonSpinner = document.getElementById("button-spinner");
    const statusIcon = document.getElementById("status-icon");
    const dropZone = document.getElementById("drop-zone");

    const ICONS = {
      spinner: `<div class="spinner w-5 h-5 rounded-full border-2"></div>`,
      success: `<svg class="w-5 h-5 text-green-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.857-9.809a.75.75 0 00-1.214-.882l-3.483 4.79-1.88-1.88a.75.75 0 10-1.06 1.061l2.5 2.5a.75.75 0 001.137-.089l4-5.5z" clip-rule="evenodd" /></svg>`,
      error: `<svg class="w-5 h-5 text-red-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.28 7.22a.75.75 0 00-1.06 1.06L8.94 10l-1.72 1.72a.75.75 0 101.06 1.06L10 11.06l1.72 1.72a.75.75 0 101.06-1.06L11.06 10l1.72-1.72a.75.75 0 00-1.06-1.06L10 8.94 8.28 7.22z" clip-rule="evenodd" /></svg>`,
    };

    // 文件选择
    videoFileInput.addEventListener("change", () => {
      if (videoFileInput.files.length > 0) {
        fileLabelText.textContent = "已选择文件:";
        fileNameDisplay.textContent = videoFileInput.files[0].name;
      } else {
        fileLabelText.textContent = "选择或拖拽电影文件";
        fileNameDisplay.textContent = "";
      }
    });

    // 拖拽支持
    ["dragenter", "dragover"].forEach((eventName) => {
      dropZone.addEventListener(eventName, (e) => {
        e.preventDefault();
        dropZone.classList.add("bg-gray-600");
      });
    });
    ["dragleave", "drop"].forEach((eventName) => {
      dropZone.addEventListener(eventName, (e) => {
        e.preventDefault();
        dropZone.classList.remove("bg-gray-600");
      });
    });
    dropZone.addEventListener("drop", (e) => {
      e.preventDefault();
      if (e.dataTransfer.files.length > 0) {
        videoFileInput.files = e.dataTransfer.files;
        fileLabelText.textContent = "已选择文件:";
        fileNameDisplay.textContent = e.dataTransfer.files[0].name;
      }
    });

    function updateStatus(text, icon = "", showProgress = false) {
      statusContainer.classList.remove("hidden");
      statusText.textContent = text;
      statusIcon.innerHTML = icon;
      progressBar.style.display = showProgress ? "block" : "none";
    }

    uploadButton.addEventListener("click", async () => {
      const file = videoFileInput.files[0];
      if (!file) {
        alert("请选择一个文件！");
        return;
      }
      uploadButton.disabled = true;
      buttonText.textContent = "处理中";
      buttonSpinner.classList.remove("hidden");
      progressBarInner.style.width = "0%";
      progressText.textContent = "";

      try {
        updateStatus("1/3: 正在请求上传许可...", ICONS.spinner);
        const response = await fetch(
          `${N8N_AUTHORIZATION_URL}?fileName=${encodeURIComponent(file.name)}`
        );
        if (!response.ok) {
          const errorText = await response.text();
          throw new Error(
            `获取许可失败: ${response.status} ${response.statusText}. 详情: ${errorText}`
          );
        }

        const data = await response.json();
        const presignedUploadUrl = data.url;
        if (!presignedUploadUrl)
          throw new Error("n8n 未返回有效的预签名 URL。");

        updateStatus("2/3: 正在上传至云端...", ICONS.spinner, true);
        await uploadFile(presignedUploadUrl, file);

        updateStatus("3/3: 上传成功！", ICONS.success);
        progressBarInner.className = "bg-green-500 h-3 rounded-full";
        progressBarInner.style.width = "100%";
        progressText.textContent = "100%";

        buttonText.textContent = "完成";
        setTimeout(() => {
          buttonText.textContent = "开始上传";
        }, 2000);
      } catch (error) {
        updateStatus(`上传失败: ${error.message}`, ICONS.error);
        progressBarInner.className = "bg-red-500 h-3 rounded-full";
        buttonText.textContent = "重试";
      } finally {
        uploadButton.disabled = false;
        buttonSpinner.classList.add("hidden");
      }
    });

    function uploadFile(url, file) {
      return new Promise((resolve, reject) => {
        const xhr = new XMLHttpRequest();
        xhr.open("PUT", url, true);
        xhr.upload.onprogress = (event) => {
          if (event.lengthComputable) {
            const percentComplete = (event.loaded / event.total) * 100;
            progressBarInner.style.width = percentComplete + "%";
            progressText.textContent = `${Math.round(
              percentComplete
            )}% (${(event.loaded / 1024 / 1024).toFixed(2)}MB / ${(
              event.total /
              1024 /
              1024
            ).toFixed(2)}MB)`;
          }
        };
        xhr.onload = () =>
          xhr.status >= 200 && xhr.status < 300
            ? resolve(xhr.response)
            : reject(new Error(`上传至 OSS 失败，状态码: ${xhr.status}`));
        xhr.onerror = () => reject(new Error("网络错误导致上传失败。"));
        xhr.setRequestHeader("Content-Type", file.type || "application/octet-stream");
        xhr.send(file);
      });
    }
  </script>
</body>
</html>
