<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CineAutoClip · S3 直传 Uploader</title>
  <style>
    :root { --bg:#0b0c10; --card:#12141a; --accent:#4da3ff; --ok:#2ecc71; --warn:#ffb020; --err:#ff4757; --text:#e6edf3; --muted:#9aa4b2; }
    *{box-sizing:border-box} body{margin:0; background:var(--bg); color:var(--text); font:16px/1.5 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,PingFang SC,Microsoft Yahei,"Helvetica Neue",Arial}
    .wrap{max-width:680px; margin:48px auto; padding:0 16px}
    .card{background:var(--card); border:1px solid #1d2330; border-radius:16px; padding:24px; box-shadow:0 10px 30px rgba(0,0,0,.25)}
    h1{margin:0 0 16px; font-size:22px}
    p.tip{margin:6px 0 18px; color:var(--muted)}
    .row{display:flex; gap:12px; align-items:center; margin:12px 0}
    input[type=file]{flex:1; padding:10px; border:1px dashed #2b3345; border-radius:10px; background:#0f121a; color:var(--muted)}
    .btn{appearance:none; border:0; background:var(--accent); color:#071018; font-weight:700; padding:10px 16px; border-radius:10px; cursor:pointer}
    .btn[disabled]{opacity:.5; cursor:not-allowed}
    .prog{height:10px; width:100%; background:#101522; border-radius:999px; overflow:hidden; border:1px solid #1e2636}
    .bar{height:100%; width:0%; background:linear-gradient(90deg,#5fb0ff,#4da3ff,#3a93ff); transition:width .1s}
    .kv{display:grid; grid-template-columns:120px 1fr; gap:8px; margin-top:14px; font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:13px; color:#c9d1d9}
    .kv .k{color:var(--muted)}
    .stat{margin-top:14px; padding:10px 12px; border-radius:10px; background:#0f131c; border:1px solid #1c2535; color:#c9d1d9}
    .ok{color:var(--ok)} .warn{color:var(--warn)} .err{color:var(--err)}
    small{color:var(--muted)}
    .grid{display:grid; grid-template-columns:1fr auto; gap:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>上传视频到 S3（直传）</h1>
      <p class="tip">支持 <b>.mp4 / .mov</b>；默认限制大小 <span id="limitLabel">2 GB</span>。上传前会先向 Lambda 获取预签名 URL，然后使用 <code>PUT</code> 直传到 S3。</p>

      <div class="grid">
        <input id="file" type="file" accept=".mp4,.mov" />
        <button id="btn" class="btn">上传</button>
      </div>

      <div class="row">
        <div class="prog" style="flex:1"><div id="bar" class="bar"></div></div>
        <div style="width:70px; text-align:right"><span id="pct">0%</span></div>
      </div>

      <div class="stat" id="stat"><small>等待选择文件…</small></div>

      <div class="kv">
        <div class="k">文件名</div><div id="kv-name">-</div>
        <div class="k">大小</div><div id="kv-size">-</div>
        <div class="k">预签名 URL</div><div id="kv-url"><small>-</small></div>
        <div class="k">S3 目标</div><div id="kv-bkt">-</div>
      </div>
    </div>

    <p class="tip" style="margin-top:14px">
      <small>注意：请确保 S3 桶 CORS 允许 <code>PUT</code> 且来源包含你的站点；Lambda Function URL CORS 需允许 <code>GET, OPTIONS</code>。直传时请不要手动设置 <code>Content-Type</code> 头（除非 Lambda 端也固定了同样的 <code>ContentType</code>）。</small>
    </p>
  </div>

<script>
/** ======= 需要你替换的配置 ======= **/
const FUNCTION_URL = "https://rllqapqieflo5pv3yyealvqvru0xprvl.lambda-url.us-east-2.on.aws/";  // 例如 https://xxx.lambda-url.us-east-2.on.aws/
const MAX_SIZE_MB = 2048;                    // 前端体积限制（可改），与后端无强绑定
/** ================================== **/

const $ = sel => document.querySelector(sel);
const elFile = $('#file'), elBtn = $('#btn'), elBar = $('#bar'), elPct = $('#pct');
const elStat = $('#stat'), elName = $('#kv-name'), elSize = $('#kv-size'), elURL = $('#kv-url'), elBkt = $('#kv-bkt');
$('#limitLabel').textContent = `${MAX_SIZE_MB} GB`.replace(' 0 GB',' 0GB');

function fmtBytes(n){
  if(!Number.isFinite(n)) return '-';
  const u=['B','KB','MB','GB','TB']; let i=0; while(n>=1024&&i<u.length-1){n/=1024;i++} 
  return `${n.toFixed( (i<2)?0:2 )} ${u[i]}`;
}
function setProgress(p){ elBar.style.width = `${p}%`; elPct.textContent = `${p|0}%`; }
function note(html,cls=''){ elStat.innerHTML = `<span class="${cls}">${html}</span>`; }

elBtn.addEventListener('click', async () => {
  try{
    const f = elFile.files?.[0];
    if(!f){ note('请先选择文件', 'warn'); return; }
    elName.textContent = f.name; elSize.textContent = fmtBytes(f.size); setProgress(0);

    // 基础校验
    const okExt = /\.(mp4|mov)$/i.test(f.name);
    if(!okExt){ note('只允许 .mp4 / .mov', 'err'); return; }
    const max = MAX_SIZE_MB * 1024 * 1024;
    if(f.size > max){ note(`文件过大（>${MAX_SIZE_MB}GB）`, 'err'); return; }

    // 1) 向 Lambda 获取预签名 URL
    note('正在请求预签名 URL…');
    const q = new URLSearchParams({ fileName: f.name });
    const r = await fetch(`${FUNCTION_URL}?${q}`, { method:'GET' });
    if(!r.ok){ throw new Error('获取预签名失败：' + r.status); }
    const { uploadUrl, bucket, expires } = await r.json();
    if(!uploadUrl) throw new Error('返回中缺少 uploadUrl');

    elURL.innerHTML = `<small>${uploadUrl.split('?')[0]}?...</small>`;
    elBkt.textContent = bucket || '-';
    note(`已获取预签名（${expires || 900}s），开始上传…`);

    // 2) 使用预签名 URL 直传到 S3（PUT）
    const xhr = new XMLHttpRequest();
    xhr.open('PUT', uploadUrl, true);

    // 不要额外设置 Content-Type；若你在 Lambda 端固定了 ContentType，这里必须设置同样的
    // xhr.setRequestHeader('Content-Type', 'video/mp4');

    xhr.upload.onprogress = (e)=>{ if(e.lengthComputable){ setProgress((e.loaded/e.total)*100); } };
    xhr.onload = ()=> {
      if(xhr.status >= 200 && xhr.status < 300){
        setProgress(100);
        note('上传成功 ✅，可以返回页面或等待后续处理。', 'ok');
      }else{
        note(`上传失败：HTTP ${xhr.status} ${xhr.statusText}`, 'err');
      }
      elBtn.disabled = false;
    };
    xhr.onerror = ()=> { note('网络错误，上传中断', 'err'); elBtn.disabled = false; };
    elBtn.disabled = true;
    xhr.send(f);

  }catch(err){
    console.error(err);
    note(`出错：${err.message || err}`, 'err');
    elBtn.disabled = false;
  }
});
</script>
</body>
</html>
