<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CineAutoClip - 视频上传</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet" />
  <style>
    body { font-family: "Inter", sans-serif; }
    .spinner { border: 3px solid transparent; border-top-color: white; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">
  <div class="bg-white shadow-xl rounded-2xl p-8 w-full max-w-md">
    <!-- Header -->
    <div class="flex flex-col items-center mb-6">
      <svg class="w-12 h-12 text-indigo-500 mb-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a1 1 0 001 1h3m10-2v1a1 1 0 01-1 1h-3m-6 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2z" />
      </svg>
      <h1 class="text-2xl font-bold text-gray-800">CineAutoClip</h1>
      <p class="text-gray-500 text-sm mt-1">电影自动化剪辑 - 上传入口</p>
    </div>
    <!-- Upload Zone -->
    <label id="drop-zone" for="video-file" class="w-full cursor-pointer border-2 border-dashed border-gray-300 rounded-xl flex flex-col items-center justify-center p-8 text-center hover:border-indigo-400 hover:bg-indigo-50 transition">
      <svg class="w-12 h-12 text-gray-400 mb-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4a1 1 0 011-1h8a1 1 0 011 1v12M7 16h10M7 16l-2 2m12-2l2 2" />
      </svg>
      <p class="text-gray-600">点击选择或拖拽文件到此处</p>
      <p id="file-name-display" class="text-indigo-500 text-sm mt-1"></p>
    </label>
    <input type="file" id="video-file" class="hidden" />
    <!-- Upload Button -->
    <button id="upload-button" class="w-full mt-6 bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-3 px-4 rounded-lg flex items-center justify-center transition disabled:bg-gray-400 disabled:cursor-not-allowed">
      <span id="button-text">开始上传</span>
      <div id="button-spinner" class="spinner ml-3 hidden"></div>
    </button>
    <!-- Status -->
    <div id="status-container" class="mt-6 hidden">
      <div class="flex items-center justify-center mb-2">
        <div id="status-icon" class="mr-2"></div>
        <p id="status-text" class="text-gray-700"></p>
      </div>
      <div id="progress-bar" class="w-full bg-gray-200 rounded-full h-3 overflow-hidden">
        <div id="progress-bar-inner" class="bg-indigo-500 h-3 w-0 transition-all duration-300"></div>
      </div>
      <p id="progress-text" class="text-xs text-gray-500 mt-1 text-right"></p>
    </div>
  </div>
  <script>
    const DEBUG = true; // ⚡ 调试开关，生产环境改成 false
    const N8N_AUTHORIZATION_URL = "https://n8n.hyl.me.uk/webhook/generate-oss-upload-url";

    const videoFileInput = document.getElementById("video-file");
    const uploadButton = document.getElementById("upload-button");
    const buttonText = document.getElementById("button-text");
    const buttonSpinner = document.getElementById("button-spinner");
    const fileNameDisplay = document.getElementById("file-name-display");
    const dropZone = document.getElementById("drop-zone");
    const statusContainer = document.getElementById("status-container");
    const statusText = document.getElementById("status-text");
    const statusIcon = document.getElementById("status-icon");
    const progressBarInner = document.getElementById("progress-bar-inner");
    const progressText = document.getElementById("progress-text");

    const ICONS = {
      success: `<svg class="w-5 h-5 text-green-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 00-1.414 0L9 11.586 6.707 9.293a1 1 0 00-1.414 1.414l3 3a1 1 0 001.414 0l7-7a1 1 0 000-1.414z" clip-rule="evenodd" /></svg>`,
      error: `<svg class="w-5 h-5 text-red-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" /></svg>`,
      spinner: `<div class="spinner"></div>`
    };

    function logDebug(...args) {
      if (DEBUG) console.log("[Uploader Debug]", ...args);
    }

    function handleFileSelect(files) {
      if (files.length > 0) {
        const file = files[0];
        videoFileInput.files = files;
        fileNameDisplay.textContent = `${file.name} (${(file.size/1024/1024).toFixed(2)} MB)`;
        logDebug("Selected file:", file.name, file.size, "bytes");
      } else {
        fileNameDisplay.textContent = "";
      }
    }

    videoFileInput.addEventListener("change", () => handleFileSelect(videoFileInput.files));

    ["dragenter", "dragover"].forEach(eventName => {
      dropZone.addEventListener(eventName, (e) => {
        e.preventDefault();
        dropZone.classList.add("border-indigo-400", "bg-indigo-50");
      });
    });

    ["dragleave", "drop"].forEach(eventName => {
      dropZone.addEventListener(eventName, (e) => {
        e.preventDefault();
        dropZone.classList.remove("border-indigo-400", "bg-indigo-50");
      });
    });

    dropZone.addEventListener("drop", (e) => {
      if (e.dataTransfer.files.length > 0) {
        handleFileSelect(e.dataTransfer.files);
      }
    });

    function updateStatus(text, icon, progressVisible = true) {
      statusContainer.classList.remove("hidden");
      statusText.textContent = text;
      statusIcon.innerHTML = icon;
      document.getElementById("progress-bar").style.display = progressVisible ? 'block' : 'none';
      if (!progressVisible) {
        progressBarInner.style.width = "0%";
        progressText.textContent = "";
      }
      logDebug("Status update:", text);
    }

    uploadButton.addEventListener("click", async () => {
      const file = videoFileInput.files[0];
      if (!file) {
        alert("请选择一个文件！");
        return;
      }
      uploadButton.disabled = true;
      buttonText.textContent = "上传中";
      buttonSpinner.classList.remove("hidden");

      try {
        updateStatus("请求上传许可中...", ICONS.spinner, false);
        const response = await fetch(`${N8N_AUTHORIZATION_URL}?fileName=${encodeURIComponent(file.name)}`);
        if (!response.ok) throw new Error(`获取上传许可失败: ${response.statusText}`);

        const data = await response.json();
        const presignedUploadUrl = data.url;
        if (!presignedUploadUrl) throw new Error("无效的预签名 URL");

        logDebug("Presigned URL:", presignedUploadUrl);

        updateStatus("正在上传文件...", ICONS.spinner, true);
        await uploadFile(presignedUploadUrl, file);

        updateStatus("上传成功！后端工作流已触发。", ICONS.success, true);
        progressBarInner.style.width = "100%";
        progressText.textContent = "100%";
        buttonText.textContent = "完成";
        buttonSpinner.classList.add("hidden");
        uploadButton.classList.replace("bg-indigo-600", "bg-green-500");
        logDebug("Upload finished:", file.name);
      } catch (err) {
        updateStatus(`上传失败: ${err.message}`, ICONS.error, false);
        buttonText.textContent = "重试";
        buttonSpinner.classList.add("hidden");
        uploadButton.classList.replace("bg-indigo-600", "bg-red-500");
        logDebug("Upload error:", err);
      } finally {
        uploadButton.disabled = false;
      }
    });

    function uploadFile(url, file) {
      return new Promise((resolve, reject) => {
        const xhr = new XMLHttpRequest();
        xhr.open("PUT", url, true);
        xhr.upload.onprogress = (e) => {
          if (e.lengthComputable) {
            const percent = (e.loaded / e.total) * 100;
            progressBarInner.style.width = percent + "%";
            progressText.textContent = `${Math.round(percent)}% (${(e.loaded/1024/1024).toFixed(2)} / ${(e.total/1024/1024).toFixed(2)} MB)`;
            logDebug(`Progress: ${percent.toFixed(2)}%`);
          }
        };
        xhr.onload = () => {
          if (xhr.status >= 200 && xhr.status < 300) {
            resolve();
          } else {
            reject(new Error(`状态码: ${xhr.status}`));
          }
        };
        xhr.onerror = () => reject(new Error("网络错误"));
        xhr.setRequestHeader("Content-Type", file.type || "application/octet-stream");
        xhr.send(file);
      });
    }
  </script>
</body>
</html>
